function initialize(){chrome.storage.local.get("websites",function(t){void 0==t.websites&&chrome.storage.local.set({websites:{}},function(){console.log("Initialized storage for websites data")})}),chrome.storage.local.get("categories",function(t){void 0==t.categories&&chrome.storage.local.set({categories:{}},function(){console.log("Initialized storage for categories data")})})}function startTrackTime(){startTime=(new Date).getTime(),chrome.tabs.query({currentWindow:!0,active:!0},function(t){tabUrl=t[0].url,currentSite=idFromUrl(tabUrl),currentlyTracking=!0,currentlyTrackingTabID=currentTabID,console.log("Started tracking "+currentSite)})}function stopTrackTime(){console.log("Stopping tracking "+currentSite+" ..."),console.log("Time: "+((new Date).getTime()-startTime));var t=(new Date).getTime()-startTime;"local"!==currentSite&&addNewData(currentSite,t),currentlyTracking=!1,currentlyTrackingTabID=null,console.log("Stopped tracking")}function restartTracking(){currentlyTracking&&stopTrackTime(),startTrackTime()}function addNewData(t,e){var i=null,n=null;getWebsiteCategory(t,function(r){chrome.storage.local.get("websites",function(n){item=n.websites[t],i=null==item?{_id:t,category:r,total_visits:0,total_time:0,month_visits:0,month_time:0,week_visits:0,week_time:0,day_visits:0,day_time:0,last_visit:null}:item,i=updateTimeAndVisits(i,e),n.websites[t]=i,chrome.storage.local.set(n,function(){console.log("New data for the "+t+" was added successfully")})}),chrome.storage.local.get("categories",function(t){item=t.categories[r],n=null==item?{_id:r,total_visits:0,total_time:0,month_visits:0,month_time:0,week_visits:0,week_time:0,day_visits:0,day_time:0,last_visit:null}:item,n=updateTimeAndVisits(n,e),t.categories[r]=n,chrome.storage.local.set(t,function(){console.log("New data for the "+r+" category was added successfully")})})})}function updateTimeAndVisits(t,e){return t.total_visits+=1,t.month_visits+=1,t.week_visits+=1,t.day_visits+=1,t.total_time+=e,t.month_time+=e,t.week_time+=e,t.day_time+=e,t.last_visit=(new Date).getTime(),t}function getWebsiteCategory(t,e){chrome.storage.local.get("websites",function(i){var n=i.websites[t];if(null!=n)return console.log("RETURNED CATEGORY: "+n.category),e(n.category);var r="undefined",o="http://productify.herokuapp.com/getwebsitecategory/"+t;$.ajax({url:o,success:function(t){return r=t.trim(),console.log(r),e(r)}})})}function idFromUrl(t){return t=t.substring(t.indexOf("//")+2),-1!==t.indexOf("/")&&(t=t.substring(0,t.indexOf("/"))),-1!==t.indexOf("www.")&&(t=t.substring(t.indexOf("www.")+4)),-1==t.indexOf(".")&&(t="local"),t}initialize();var currentSite=null,startTime=null,currentlyTrackingTabID=null,currentlyTracking=!1,currentTabID=-1,tabUrl=null;chrome.windows.onFocusChanged.addListener(function t(e){"-1"==e?(console.log("Chrome window became inactive, stopping tracking..."),stopTrackTime()):currentlyTracking?(console.log("User switched to another Chrome window, restarting tracking..."),restartTracking()):(console.log("Chrome window became active, restarting tracking..."),restartTracking())}),chrome.tabs.onUpdated.addListener(function(t,e){"complete"==e.status&&t==currentTabID&&(console.log("Tab was updated, restarting tracking..."),restartTracking())}),chrome.tabs.onSelectionChanged.addListener(function(t,e){console.log("Selection changed, restarting tracking..."),currentTabID=t,restartTracking()}),chrome.tabs.onCreated.addListener(function(t,e){console.log("New tab opened, restarting tracking..."),currentTabID=t,restartTracking()});