function initialize(){chrome.storage.local.get("websites",function(e){void 0==e.websites&&chrome.storage.local.set({websites:{}},function(){console.log("Initialized storage for websites data")})}),chrome.storage.local.get("categories",function(e){void 0==e.categories&&chrome.storage.local.set({categories:{}},function(){console.log("Initialized storage for categories data")})}),chrome.storage.local.get("date",function(e){if(void 0==e.date){var t=new Date,o={date:t.getDate(),day:t.getDay(),month:t.getMonth()};chrome.storage.local.set({date:o},function(){console.log("Initialized storage for date data")})}}),chrome.storage.local.get("settings",function(e){if(void 0==e.settings){var t={focus:!1};chrome.storage.local.set({settings:t},function(){console.log("Initialized storage for settings")})}})}function checkForFocusMode(){chrome.storage.local.get("settings",function(e){var t=e.settings;t.focus&&chrome.tabs.query({currentWindow:!0,active:!0},function(e){tabUrl=e[0].url,currentSite=idFromUrl(tabUrl),getWebsiteCategory(currentSite,function(e){$.inArray(e,unproductiveCategories)>-1&&chrome.tabs.getSelected(null,function(e){chrome.tabs.update(e.id,{url:"../notimeleft.html"})})})})})}function startTrackTime(){startTime=(new Date).getTime(),chrome.tabs.query({currentWindow:!0,active:!0},function(e){tabUrl=e[0].url,currentSite=idFromUrl(tabUrl),currentlyTracking=!0,currentlyTrackingTabID=currentTabID,console.log("Started tracking "+currentSite)})}function stopTrackTime(){console.log("Stopping tracking "+currentSite+" ..."),console.log("Time: "+((new Date).getTime()-startTime));var e=(new Date).getTime()-startTime;"local"!==currentSite&&addNewData(currentSite,e),currentlyTracking=!1,currentlyTrackingTabID=null,console.log("Stopped tracking"),checkDate()}function restartTracking(){checkForFocusMode(),currentlyTracking&&stopTrackTime(),startTrackTime()}function addNewData(e,t){var o=null,i=null;getWebsiteCategory(e,function(n){chrome.storage.local.get("websites",function(i){item=i.websites[e],o=null==item?{_id:e,category:n,total_visits:0,total_time:0,month_visits:0,month_time:0,week_visits:0,week_time:0,day_visits:0,day_time:0,last_visit:null}:item,o=updateTimeAndVisits(o,t),i.websites[e]=o,chrome.storage.local.set(i,function(){console.log("New data for the "+e+" was added successfully")})}),chrome.storage.local.get("categories",function(e){item=e.categories[n],i=null==item?{_id:n,total_visits:0,total_time:0,month_visits:0,month_time:0,week_visits:0,week_time:0,day_visits:0,day_time:0,last_visit:null}:item,i=updateTimeAndVisits(i,t),e.categories[n]=i,chrome.storage.local.set(e,function(){console.log("New data for the "+n+" category was added successfully")})})})}function updateTimeAndVisits(e,t){return e.total_visits+=1,e.month_visits+=1,e.week_visits+=1,e.day_visits+=1,e.total_time+=t,e.month_time+=t,e.week_time+=t,e.day_time+=t,e.last_visit=(new Date).getTime(),e}function checkDate(){chrome.storage.local.get("date",function(e){var t=e.date,o=new Date;(o.getDate()!=t.date||o.getMonth()!=t.month)&&(resetTimeFor("day"),(0==o.getDay()||o.getMonth()!=t.month||o.getDay()<t.day||o.getDate()-t.date>7)&&(resetTimeFor("week"),o.getMonth()!=t.month&&resetTimeFor("month")));var t=new Date,i={date:t.getDate(),day:t.getDay(),month:t.getMonth()};chrome.storage.local.set({date:i},function(){console.log("Updated stored date")})})}function resetTimeFor(e){chrome.storage.local.get(["categories","websites"],function(t){var o=t.categories,i=t.websites;for(key in o)o[key][e+"_time"]=0,o[key][e+"_visits"]=0;for(key in i)i[key][e+"_time"]=0,i[key][e+"_visits"]=0;t.websites=i,t.categories=o,chrome.storage.local.set(t,function(){})})}function getWebsiteCategory(e,t){chrome.storage.local.get("websites",function(o){var i=o.websites[e];if(null!=i)return console.log("RETURNED CATEGORY: "+i.category),t(i.category);var n="undefined",a="http://productify.herokuapp.com/getwebsitecategory/"+e;$.ajax({url:a,success:function(e){return n=e.trim(),console.log(n),t(n)}})})}function idFromUrl(e){return e=e.substring(e.indexOf("//")+2),-1!==e.indexOf("/")&&(e=e.substring(0,e.indexOf("/"))),-1!==e.indexOf("www.")&&(e=e.substring(e.indexOf("www.")+4)),-1==e.indexOf(".")&&(e="local"),e}chrome.storage.local.clear(),initialize();var currentSite=null,startTime=null,currentlyTrackingTabID=null,currentlyTracking=!1,currentTabID=-1,tabUrl=null,unproductiveCategories=["Gambling","Games","Internet and Telecom","Social","People and Society","Sports","Shopping","Adult","News and Media","Arts and Entertainment"];chrome.windows.onFocusChanged.addListener(function e(t){"-1"==t?(console.log("Chrome window became inactive, stopping tracking..."),stopTrackTime()):currentlyTracking?(console.log("User switched to another Chrome window, restarting tracking..."),restartTracking()):(console.log("Chrome window became active, restarting tracking..."),restartTracking())}),chrome.tabs.onUpdated.addListener(function(e,t){"complete"==t.status&&e==currentTabID&&(console.log("Tab was updated, restarting tracking..."),restartTracking())}),chrome.tabs.onSelectionChanged.addListener(function(e,t){console.log("Selection changed, restarting tracking..."),currentTabID=e,restartTracking()}),chrome.tabs.onCreated.addListener(function(e,t){console.log("New tab opened, restarting tracking..."),currentTabID=e,restartTracking()});